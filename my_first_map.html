<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>My Web GIS</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        #map {
            height: 600px;
            width: 100%;
        }
    </style>
</head>

<body>
  <header>
    <h1><i class="fa-solid fa-map-location-dot"></i> Web GIS </h1>
  </header>
  <div id="map"></div>

  <script>
    // สร้างแผนที่และตั้งจุดเริ่มต้น
    var map = L.map('map').setView([16.744, 100.191], 13);
    var markers = []; // Array to store markers

    // ================= Base Maps =================
    var google_map = L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}', { maxZoom: 18 });
    var openstreetmap = L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
    var EsriWorldStreetMap = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 18 });
    var EsriWorldImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 18 });
    var cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19, subdomains: ['a', 'b', 'c', 'd'], attribution: '&copy; CartoDB'
    });
    var cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19, subdomains: ['a', 'b', 'c', 'd'], attribution: '&copy; CartoDB'
    });
    var openTopoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17, attribution: 'Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap (CC-BY-SA)'
    });
    var wikimediaMap = L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}{r}.png', {
        maxZoom: 19, attribution: '<a href="https://wikimediafoundation.org/wiki/Maps_Terms_of_Use">Wikimedia</a>'
    }).addTo(map); // Default basemap

    // =============== Custom Features ===============
    var buildingIcon = L.icon({
        iconUrl: 'https://img.lovepik.com/png/20231115/hospital-building-clipart-3d-isometric-illustration-medical-office-building-with_597059_wh1200.png',
        iconSize: [50, 50],
        iconAnchor: [25, 50],
        popupAnchor: [0, -50]
    });

    var marker = L.marker([16.746, 100.1959], { icon: buildingIcon })
        .bindPopup("คณะเกษตรศาสตร์ฯ มหาวิทยาลัยนเรศวร");

    var circle = L.circle([16.746, 100.1959], { radius: 200, color: "blue", fillOpacity: 0.2 });

    var polyline = L.polyline([
        [16.742, 100.180], [16.735, 100.189], [16.735, 100.190], [16.739, 100.189]
    ], { color: 'red' });

    var polygon = L.polygon([
        [16.752, 100.176], [16.743, 100.176], [16.743, 100.190], [16.752, 100.190]
    ], { color: 'green' });

    function popUp(f, l) {
        var out = [];
        if (f.properties) {
            for (key in f.properties) {
                out.push(key + ": " + f.properties[key]);
            }
            l.bindPopup(out.join("<br />"));
        }
    }

    var ThaiProvJSON = new L.GeoJSON.AJAX(['thailand_province.geojson'], {
        onEachFeature: popUp
    });

    function sendtodb() {
        var lat = document.getElementById('lat').value;
        var lng = document.getElementById('lng').value;
        var distance = document.getElementById('distance').value;

        console.log("Data to send:", { lat: lat, lng: lng, distance: distance });
        alert("Data to send:\nLat: " + lat + "\nLng: " + lng + "\nDistance: " + distance);
    }

    // Layer groups for API data
    var thaiwaterLayer = L.layerGroup().addTo(map);
    var rain24hLayer = L.layerGroup().addTo(map);

    function getColor(rain) {
        return rain > 90 ? '#800026' :
            rain > 60 ? '#BD0026' :
            rain > 30 ? '#E31A1C' :
            rain > 15 ? '#FC4E2A' :
            rain > 5 ? '#FD8D3C' :
            rain > 1 ? '#FEB24C' :
            rain > 0 ? '#FED976' : '#FFEDA0';
    }

    function loadAPIData() {
        $.getJSON("https://api-v3.thaiwater.net/api/v1/thaiwater30/public/thailand_main_rain?province_code=60", function(res) {
            if (res.result === "OK") {
                res.data.forEach(function(d) {
                    if (d.station && d.station.tele_station_lat && d.station.tele_station_long) {
                        var lat = parseFloat(d.station.tele_station_lat),
                            lng = parseFloat(d.station.tele_station_long);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            var popup = "<b>สถานี:</b> " + d.station.tele_station_name.th + "<br><b>จังหวัด:</b> " + d.geocode.province_name.th + "<br><b>ฝนสะสม 24 ชม.:</b> " + d.rain_24h + " มม." + "<br><b>เวลา:</b> " + d.rainfall_datetime;
                            var nakhonSawanIcon = L.divIcon({
                                html: '<i class="fa-solid fa-cloud-showers-heavy fa-2x" style="color: blue; text-shadow: 1px 1px 2px #fff;"></i>',
                                className: 'custom-div-icon',
                                iconSize: [30, 42],
                                iconAnchor: [15, 42],
                                popupAnchor: [0, -35]
                            });
                            L.marker([lat, lng], { icon: nakhonSawanIcon }).bindPopup(popup).addTo(thaiwaterLayer);
                        }
                    }
                });
            }
        });

        $.getJSON("https://api-v3.thaiwater.net/api/v1/thaiwater30/public/rain_24h", function(res) {
            if (res.result === "OK") {
                res.data.forEach(function(d) {
                    if (d.station && d.station.tele_station_lat && d.station.tele_station_long) {
                        var lat = parseFloat(d.station.tele_station_lat),
                            lng = parseFloat(d.station.tele_station_long);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            var rain = parseFloat(d.rain_24h);
                            var iconColor = getColor(rain);
                            var rainIcon = L.divIcon({
                                html: '<i class="fa-solid fa-cloud-showers-heavy fa-2x" style="color: ' + iconColor + '; text-shadow: 1px 1px 2px #fff;"></i>',
                                className: 'custom-div-icon',
                                iconSize: [30, 42],
                                iconAnchor: [15, 42],
                                popupAnchor: [0, -35]
                            });
                            var popup = "<b>สถานี:</b> " + d.station.tele_station_name.th + "<br><b>จังหวัด:</b> " + d.geocode.province_name.th + "<br><b>ฝนสะสม 24 ชม.:</b> " + d.rain_24h + " มม." + "<br><b>เวลา:</b> " + d.rainfall_datetime;
                            L.marker([lat, lng], { icon: rainIcon }).bindPopup(popup).addTo(rain24hLayer);
                        }
                    }
                });
            }
        });
    }
    loadAPIData();

    var baseLayers = {
        "Google Map": google_map,
        "OpenStreetMap": openstreetmap,
        "Esri Street": EsriWorldStreetMap,
        "Esri Imagery": EsriWorldImagery,
        "Carto Light": cartoLight,
        "Carto Dark": cartoDark,
        "OpenTopoMap": openTopoMap,
        "Wikimedia": wikimediaMap
    };

    var overlays = {
        "จุด": marker,
        "วงกลม": circle,
        "เส้น": polyline,
        "สี่เหลี่ยม": polygon,
        "ขอบเขตจังหวัด000 (GeoJSON)": ThaiProvJSON,
        "สถานีฝน (นครสวรรค์)": thaiwaterLayer,
        "สถานีฝน (ทั่วประเทศ)": rain24hLayer
    };

    L.control.layers(baseLayers, overlays).addTo(map);

    // ----------------- Click Event (Search By Distance) ----------------- 
    var marker_arr=[];
    var showpoint = null;

    map.on("click", function(e){
      if(marker_arr.length > 0){
        for(i=0;i<marker_arr.length;i++){
          map.removeLayer(marker_arr[i]);
        }
      }

      var ct="<center><h3>Search By Distance</h3></center>";
      ct +="Lat: <input type='number' id='lat' value=" +e.latlng.lat + ">";
      ct +="<br>Lng: <input type='number' id='lng' value=" +e.latlng.lng + "><br>";
      ct +="Distance: <input type='text' id='distance'>";
      ct +="<br><br><center><button onclick='sendtodb();'>Submit</button></center>";

      var marker=new L.Marker([e.latlng.lat,e.latlng.lng])
        .addTo(map).bindPopup(ct).openPopup();

      marker_arr.push(marker);
    });

    // ----------------- DblClick & RightClick Event (Insert to DB) -----------------
    var marker_arr2=[];

    map.on("dblclick", function(e){
      if(marker_arr2.length > 0){
        for(i=0;i<marker_arr2.length;i++){
          map.removeLayer(marker_arr2[i]);
        }
      }

      var ct="<center><h3>Add clicked location data</h3></center>";
      ct +="Lat: <input type='number' id='lat' value=" +e.latlng.lat + ">";
      ct +="<br>Lng: <input type='number' id='lng' value=" +e.latlng.lng + "><br>";
      ct +="Name: <input type='text' id='name'>";
      ct +="<br><br><center><button onclick='inserttodb();'>Submit</button></center>";

      var marker1=new L.Marker([e.latlng.lat, e.latlng.lng])
        .addTo(map).bindPopup(ct).openPopup();

      marker_arr2.push(marker1);
    });

    map.on("contextmenu", function(e){
      if(marker_arr2.length > 0){
        for(i=0;i<marker_arr2.length;i++){
          map.removeLayer(marker_arr2[i]);
        }
      }
    });
  </script>
</body>
</html>
